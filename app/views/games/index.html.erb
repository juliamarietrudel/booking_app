<div class="main-container" id="main-container-games">
  <div class="container-titles">
    <h1>Clickez sur les dates pour lesquelles vous voulez jouer</h1>
    <h2>Vous avez confimé que vous voulez jouer:
      <p class="days-confirmed"><%= @player.participations.map { |p| p.game.date.strftime("%A") }.to_sentence(last_word_connector: ' and ', two_words_connector: ' and ') %></p>
    </h2>
  </div>
  <div class="form-container">
    <div class="button-container">
      <% @games.each do |game| %>
        <%= form_with(url: create_or_destroy_participation_path(token: @player.token, game_id: game.id), method: :post, local: true) do |form| %>
          <%= submit_tag game.date.strftime("%A the %dth of %B"), class: "confirm-button",
            data: { player_token: @player.token || 'No player found', game_id: game.id || 'No game found'} do %>
          <% end %>
        <% end %>
      <% end %>
    </div>
    <div class="form-center">
      <%= form_with(url: add_comment_path(token: @player.token), method: :post, local: true, html: { class: 'form-justify' }) do |form| %>
        <%= form.text_field :comment, class: 'input-field' %>
        <%= form.submit 'Continue', class: 'comment-confirm-button' %>
      <% end %>
    </div>
  </div>

  <div class="container-exit">
    <h2>Cliquez sur le x en dessous quand vous avez terminé</h2>
    <div id="close-page-button"><i class="fa-solid fa-xmark"></i></div>
  </div>
</div>


<script>
  const commentConfirmButton = document.querySelector('.comment-confirm-button');
  const buttons = document.querySelectorAll('.confirm-button');
  const closeButton = document.querySelector('#close-page-button');

  //  disable comment confirm button
  const disableCommentButton = () => {
    commentConfirmButton.disabled = true;
    commentConfirmButton.setAttribute('id', 'disabled-button')
    commentConfirmButton.value = 'Commentaire Envoyé';
  }

  // if (localStorage.getItem('commentButtonClicked')) disableCommentButton();

  commentConfirmButton.addEventListener('click', (event) => {
    event.preventDefault();
    disableCommentButton();
    // localStorage.setItem('commentButtonClicked', true);
    event.target.form.submit();
  })

  // load page with appropriate button colors
  document.addEventListener('DOMContentLoaded', (event) => {
    buttons.forEach((button) => {
      playerToken = button.dataset.playerToken;
      gameId = button.dataset.gameId;
      fetch(`/players/${playerToken}/games/${gameId}/participation_exists`)
      .then(response => response.json())
      .then(data => {
        console.log(data.exists);
        if (data.exists) button.classList.add('confirmed-button');
      })
    })

  });

  // change button colors when click
  buttons.forEach((button) => {
    playerToken = button.dataset.playerToken;
    gameId = button.dataset.gameId;

    button.addEventListener('click', (event) => {
      event.preventDefault();
      fetch(`/players/${playerToken}/games/${gameId}/participation_exists`)
      .then(response => response.json())
      .then(data => {
        if (data.exists) {
          console.log(data.exists);
          // button.style.backgroundColor = '#023e7f';
          button.classList.add('color-confirmed');
          button.form.submit(); // This manually submits the form
        } else {
          console.log(data.exists);
          // button.style.backgroundColor = '#007bff';
          button.form.submit(); // This manually submits the form
        }
      })
    })
  });

  // close page
  closeButton.addEventListener('click', function() {
    window.close();
    // console.log('trying to close')
  })
</script>
