<h1>Upcoming Games</h1>
<% @games.each do |game| %>
  <%= form_with(url: confirm_game_path, method: :post, local: true, remote: true) do |form| %>
    <%= hidden_field_tag :game_id, game.id %>
    <%= hidden_field_tag :token, params[:token] %>
    <%= submit_tag game.date.strftime("%A"), class: "confirm-button",
      data: { player: @player.token || 'No player found', game_id: game.id || 'No game found'} %>
  <% end %>
<% end %>

<% flash.each do |key, value| %>
  <div class="<%= key %>"><%= value %></div>
<% end %>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const buttons = document.querySelectorAll('.confirm-button');

  buttons.forEach(button => {
    button.addEventListener('click', function(event) {
      event.preventDefault(); // Prevent the form from submitting normally

      const gameId = button.dataset.gameId;
      const playerToken = button.dataset.player;

      fetch(`/games/${gameId}/participations?token=${playerToken}`, {
        method: 'POST', // Assuming you want to create or delete a participation
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('AA: Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        updateButtonStyles(); // Call this function to reapply the button styles
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
  });

  // Function to update button styles
  function updateButtonStyles() {
    buttons.forEach(button => {
      const gameId = button.dataset.gameId;
      const playerToken = button.dataset.player;

      fetch(`/games/${gameId}/participations?token=${playerToken}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (Array.isArray(data) && data.length > 0) {
          button.style.backgroundColor = 'blue'; // Change color if participations exist
        } else {
          button.style.backgroundColor = 'pink'; // Change color if no participations exist
        }
      })
      .catch(error => {
        console.error('Error fetching participations:', error);
      });
    });
  }

  updateButtonStyles(); // Call this initially to set the correct styles on page load
});



// function handleButtonClick(event, gameId, playerToken) {
//   event.preventDefault();
//   button = event.currentTarget;
//   fetch(`/games/${gameId}/participations?token=${playerToken}`)
//   .then(response => {
//     console.log('*** API INFO ***')
//     if (!response.ok) {
//         throw new Error (' Failed to fetch participation data')
//         console.log('unsuccessful');
//     }
//     console.log('successful')
//     return response.json()
//   })
//   .then(data => {
//     console.log(data);
//     if (data.length > 0) {
//       console.log('Participation exists');
//       button.style.backgroundColor = 'blue'
//     } else {
//       console.log('Participation doesnt exist');
//       button.style.backgroundColor = 'pink'
//     }
//   })
// }

  // function confirmDay(event) {
  //   // prevent default form submission behavior
  //   event.preventDefault()

  //   // select button and find game and player
  //   const button = event.currentTarget;
  //   const gameId = button.dataset.gameId;
  //   console.log(`Game ID: ${gameId}`);
  //   const playerToken = button.dataset.player;
  //   console.log(`Player Token: ${playerToken}`)

  //   // send ajax request
  //   fetch(`/games/${gameId}/participations?token=${playerToken}`)
  //   .then(response => {
  //     if (!response.ok) {
  //       // throw new Error (' Failed to fetch participation data')
  //       console.log('unsuccessful');
  //     }
  //     console.log('***** FETCH API INFO *****')
  //     console.log('succesful');
  //     return response.json()
  //   })
  //   .then(data => {
  //     console.log(data)
  //     // if (data && data.length > 0) {
  //     //   console.log('Participation ID:',data[0].id)
  //     //   button.style.color = 'green'
  //     // } else {
  //     //   console.log('No participation exists');
  //     //   button.style.color = "red"
  //     // }
  //   })
  //   .catch(error => {
  //     console.error('Error fetching participation:', error);
  //   })
  // }
</script>


<%# <script>
  function confirmDay(event) {
    const button = event.currentTarget;
    const playerInfo = button.dataset.player;
    const gameDate = button.dataset.game;
    button.classList.toggle('confirmed')

    if (button.classList.contains('confirmed')) {
      console.log('confirmed the date')
    } else {
      console.log('unbooked')
    }
  }
</script> %>
